"PART 2 HANDOFF REPORT (Chat-only) — Backend + APIM + Search Fixes + Next Azure/Backend Completion Steps
Project: Digital Evidence Management System (DEMS)
Scope of this report: ONLY what happened in Part 2 (this chat). No Part 1 recap.

================================================================================
0) Goals and decisions confirmed in this chat (Part 2 scope)
================================================================================
Primary goal (Part 2):
- Implement a production-ready backend under /backend using Azure Functions (Node.js + TypeScript).
- Put Azure API Management (APIM) in front of the Functions.
- Use Microsoft Entra ID (Workforce) access tokens with role-based authorization.
- Use SAS-based evidence upload: backend issues short-lived SAS, frontend uploads directly to Blob, backend confirms metadata.
- Use a Blob-trigger processing pipeline for OCR and indexing:
  - OCR via Azure Computer Vision / Vision Read API
  - Store normalized metadata + status in Cosmos DB
  - Push searchable document to Azure AI Search
- Secrets via Key Vault (Key Vault references in Function App settings), Managed Identity for Azure access.
- No Event Grid. No Analytics service in this architecture.
- Part 3 is NOT frontend adaptation. Part 3 is backend + Azure completion. Part 4 is frontend adaptation.

Important clarification made in this chat:
- Publishing a Function App (func azure functionapp publish) does NOT automatically update APIM operations.
  APIM operations must be imported/created manually or via APIM import steps.

================================================================================
1) What was implemented/delivered in Part 2
================================================================================
1.1 Backend delivered as a full /backend folder
- A complete Azure Functions (Node.js + TypeScript) backend was provided as a replacement folder in a zip.
- It includes:
  - HTTP APIs for auth, departments, cases, evidence, users
  - Shared libraries for auth/JWT parsing, Cosmos access, storage SAS generation, Search push/query, Vision OCR client
  - Blob-trigger function for evidence processing
  - Local development configuration (local.settings.json) and build scripts (npm scripts)

1.2 Core backend features implemented
A) Auth
- GET /api/auth/me
  - Returns current user identity and roles extracted from the access token.
  - Used to drive frontend RBAC later.

B) Evidence (SAS-based upload)
- POST /api/evidence/upload-init
  - Returns SAS upload URL + blob path + new evidenceId.
- POST /api/evidence/upload-confirm
  - Registers metadata after the client uploads to Blob using SAS.
- GET /api/evidence
  - List evidence (supports filtering by caseId when implemented/extended).
- GET /api/evidence/id/{evidenceId}
  - Fetch evidence record by id. (NOTE: route changed during your fixes; see Section 2.)
- GET /api/evidence/search
  - Searches in Azure AI Search.
- GET /api/evidence/id/{evidenceId}/status
  - Returns processing status.

C) Cases
- GET /api/cases
- POST /api/cases
- GET /api/cases/{caseId}
- PATCH /api/cases/{caseId}
- DELETE /api/cases/{caseId}
- POST /api/cases/{caseId}/notes

D) Departments
- GET /api/departments
- POST /api/departments
- PATCH /api/departments/{id}
- DELETE /api/departments/{id}

E) Admin user provisioning
- POST /api/users
  - Intended to create users via Microsoft Graph API (admin-only).
  - Requires additional Entra App Registration / Graph permissions (pending guide + finalization; see Section 5).

1.3 Processing pipeline implemented (Blob-trigger)
- Trigger: blob creation in evidence-raw container (Blob trigger).
- Minimal processing in Part 2: OCR (text extraction) using Azure Vision Read API.
- Writes:
  - Cosmos DB: evidence metadata + extractedText + status transitions (e.g., UPLOADED → PROCESSING → COMPLETED/FAILED)
  - Azure AI Search: pushes searchable doc including extractedText + tags (where applicable)

Important note clarified in chat:
- Part 2 implementation is OCR-focused. It does NOT yet do crime-scene object detection (guns/knives/blood).
  That is a future/optional extension; it is tracked as pending for later parts, not Part 3 unless explicitly requested.

================================================================================
2) What you changed locally after Part 2 delivery (your fixes)
================================================================================
You reported: “All tests are working but I had to change routes and some backend files to fix errors.”

2.1 APIM operation routes changed/confirmed (current state)
You confirmed the current operations in APIM via:
az apim api operation list ... --api-id func-dems1

Current operations table (as you posted):
- GET    /api/auth/me
- GET    /ping
- GET    /api/departments
- POST   /api/departments
- PATCH  /api/departments/{id}
- DELETE /api/departments/{id}
- GET    /api/cases
- POST   /api/cases
- GET    /api/cases/{caseId}
- PATCH  /api/cases/{caseId}
- DELETE /api/cases/{caseId}
- POST   /api/cases/{caseId}/notes
- GET    /api/evidence
- GET    /api/evidence/id/{evidenceId}
- GET    /api/evidence/id/{evidenceId}/status
- GET    /api/evidence/search
- POST   /api/evidence/upload-init
- POST   /api/evidence/upload-confirm
- POST   /api/users
- (leftover) GET /HttpApi
- (leftover) POST /HttpApi

Key change vs original backend suggestion:
- Evidence routes were changed from:
  /api/evidence/{evidenceId}
  /api/evidence/{evidenceId}/status
  to:
  /api/evidence/id/{evidenceId}
  /api/evidence/id/{evidenceId}/status

================================================================================
3) Azure AI Search index update you applied (critical fix for search)
================================================================================
You added/updated the AI Search index “evidence-idx” so search works.
You provided the exact index definition; the important fields are:

Key fields:
- id (key, filterable, retrievable)
- caseId (filterable/sortable/facetable)
- department (filterable/sortable/facetable)
- fileName (searchable)
- fileType (filterable/facetable)
- uploadedAt (filterable/sortable)
- uploadedBy (filterable/facetable)
- status (filterable/sortable/facetable)
- description (searchable)
- tags (Collection(Edm.String)) searchable + filterable + facetable
- extractedText (searchable)

This index shape is aligned with the planned pipeline:
- extractedText drives full-text search
- tags enable future “vision tagging” + filtering
- caseId/department/status enable structured filtering and faceting

================================================================================
4) APIM guidance that was executed (and what matters now)
================================================================================
4.1 Main principle confirmed in chat
- Deploying Functions does not update APIM operations automatically.
- You chose Option B: create/import each APIM operation explicitly.
- Verified via CLI that operations exist.

4.2 Where policies live in APIM (the exact location used)
- APIM → APIs → func-dems1 → All operations → Policies (Inbound/Outbound)
- For stricter enforcement: APIM → APIs → func-dems1 → Operations → <operation> → Policies

4.3 Policy intent agreed in this chat
- API-level: CORS + validate-jwt (Entra v2 openid-config, correct audience, correct issuer)
- Operation-level: role enforcement for admin-only endpoints (e.g., POST /api/users; and admin-only dept mutations if desired)


================================================================================
5) RBAC model (must be implemented/enforced) — final role semantics you require
================================================================================
These are the role definitions you provided and must be reflected in backend authorization logic + APIM policies.
(These semantics are mandatory; current backend logic must be reviewed/updated in Part 3 to match exactly.)

#### 1. Admin (System Administrator)
- Purpose: Platform governance and system configuration
- Access: User management, roles, departments, authentication settings
  - Add and delete users
  - Edit user role, department, and badge ID at any time
  - Manage departments (add, edit display name, delete when not in use)
  - Username is immutable after creation; users change their own password from Profile
- Restrictions: ZERO access to investigative content (cases, evidence, analytics)
- Use Case: IT administrators, system managers who should not view investigative data

#### 2. Detective (Cross-Department Investigator)
- Purpose: Senior investigative authority with full operational access
- Access: All departments, all cases, full CRUD operations on cases and evidence
- Capabilities: Create/edit/delete cases, upload/delete evidence, cross-department search
- Use Case: Senior detectives, task force members, central investigative units

#### 3. Case Officer (Department-Scoped Investigator)
- Purpose: Department-specific investigative work
- Access: Only cases within assigned department
- Capabilities: Create/manage department cases, upload evidence, add notes, department-specific search
- Restrictions: Cannot access other departments' cases or evidence
- Use Case: Field officers, department investigators, unit-specific personnel

#### 4. Prosecutor (Judicial / Legal Reviewer)
- Purpose: Legal oversight and case preparation
- Access: Read-only access to ALL departments, cases, and evidence
- Capabilities: Review evidence, metadata, timelines, chain-of-custody
- Restrictions: Cannot upload, modify, delete, or reclassify any evidence
- Use Case: District attorneys, legal reviewers, judicial oversight

IMPORTANT enforcement correction for Part 3:
- Current backend (as initially delivered) likely allows admin to access investigative endpoints because it uses “admin” as a superuser.
- Your requirement explicitly forbids admin from seeing cases/evidence.
- Part 3 must implement this separation (either by rejecting admin role on case/evidence routes, or by requiring an “investigative role” claim).
- Part 3 must specify how to give multiple roles to a member.

================================================================================
6) Data relationships & constraints that are pending (must be enforced in backend)
================================================================================
These constraints must be enforced server-side in Part 3:

1) Department → Case → Evidence hierarchy
- A Case must belong to exactly one Department.
- Evidence must belong to exactly one Case.
- Evidence must NOT exist without a Case.
- Case must NOT exist without a Department.

2) Enforcement points (backend)
- POST /api/cases must require departmentId (or department field) and validate the department exists.
- POST /api/evidence/upload-init and upload-confirm must require caseId and validate:
  - case exists
  - caller has access to that department/case based on role rules

3) Deletion constraints
- Deleting a Department must be blocked if it has Cases.
- Deleting a Case must be blocked if it has Evidence (or implement cascading delete deliberately with audit).
- Deleting Evidence should preserve audit requirements (if applicable).

4) Index/Query alignment
- Evidence search must support filtering by:
  - department (for Case Officer scope)
  - caseId
  - status
  - tags
- Ensure Search docs contain department and caseId fields (your index supports them).

================================================================================
7) Vision/OCR status in this chat and what’s next
================================================================================
7.1 What is working now
- OCR (Read API) is implemented and functioning in your environment.
- Evidence pipeline extracts text (extractedText) and pushes it to Search.
- Search index now supports extractedText, description, tags.

7.2 What is NOT implemented yet (explicitly pending)
- Restrict uploads to images only (backend enforcement). You noted you can do temporary frontend blocking, but backend should enforce allowlist in Part 3.
- Vision object detection / tagging (e.g., people, weapons, gore/blood) is NOT implemented in Part 2.
- If/when you choose to implement tagging:
  - Use Azure Vision Image Analysis (tags/objects/people) and store results into Cosmos evidence.analysis.* and Search fields (tags, objects).
  - “Gore/blood” detection is not guaranteed by default tagging; may require custom model or different service. Track as optional scope.

IMPORTANT instruction you gave:
- Vision object detection / gore tagging is a pending task for later parts.
- It must NOT be done in Part 3 unless explicitly requested; keep it as a handoff item.

================================================================================
8) Current APIM routing state (authoritative, from your CLI output)
================================================================================
API in APIM: func-dems1

Active operations (expected to be used by frontend later):
- GET /api/auth/me
- GET /ping
- Departments: GET/POST/PATCH/DELETE under /api/departments
- Cases: GET/POST/GET by id/PATCH/DELETE + notes
- Evidence: list, get-by-id via /api/evidence/id/{evidenceId}, status, search, upload-init/confirm
- Admin: POST /api/users

Leftovers to remove:
- GET /HttpApi
- POST /HttpApi

================================================================================
9) Pending tasks for Part 3 (Backend + Azure completion) — DO NOT skip
================================================================================
Part 3 scope (you clarified): backend + azure completion (NOT frontend).

9.1 Authorization + RBAC correctness (must match your role semantics)
- Enforce “Admin has zero investigative access”:
  - Admin can manage users/roles/departments only.
  - Admin must be blocked from all case/evidence endpoints.
- Enforce Case Officer department scoping:
  - Case Officer can only see/create/update cases and evidence in their assigned department.
- Enforce Prosecutor read-only:
  - Prosecutor can read but cannot create/update/delete cases/evidence and cannot upload evidence.
- Detective full operational access:
  - CRUD cases + evidence across all departments.
- Implement these checks in backend first, then mirror with APIM policy as “defense in depth”.

9.2 Identity attributes needed for scoping
- Case Officer must have an assigned department.
- Prosecutor/detective may not need department scoping.
Pending design in Part 3:
- Decide where to store “user → departmentId (for case officers)”:
  - Option A: store in Cosmos users container (users table), keyed by Entra oid.
  - Option B: rely on Entra claims (requires custom claims / extension attributes).
Recommendation for Part 3: Cosmos users container mapping is simplest.

9.3 Admin guide: how admin creates members and assigns roles (required)
Deliverable required in Part 3:
- Step-by-step guide for admin to:
  1) Create/invite a user in Entra
  2) Assign App Role: admin/detective/case_officer/prosecutor
  3) Optionally assign department for case officers (via Cosmos users container or Entra extension attribute)
  4) Verify the user token contains the role and that backend recognizes department scope

9.4 Microsoft Graph user provisioning endpoint completion
- POST /api/users requires Graph app registration + permissions (application permissions likely).
- Part 3 must:
  - Decide provisioning strategy:
    - Manual creation in Entra portal (simplest; API endpoint optional)
    - Or backend-driven creation via Graph (requires secure secret handling)
  - If keeping POST /api/users:
    - Create an Entra app registration for Graph
    - Grant proper Graph permissions
    - Store client secret/cert in Key Vault
    - Add Function App settings (Key Vault references)
    - Ensure APIM enforces admin-only for this endpoint

9.5 Data integrity constraints
- Enforce Department → Case → Evidence constraints (see Section 6).
- Block invalid creations and invalid deletions.
- Ensure evidence upload-init/confirm always validates case existence and user access.

9.6 Search integration hardening
- Ensure every evidence document pushed to Search includes:
  - caseId, department, status, extractedText, tags
- Add safe query filtering:
  - Case Officer: filter by department
  - Prosecutor: no filter but read-only
- Ensure Search RBAC roles for Function managed identity remain correct.

9.7 Blob-trigger reliability & observability
- Ensure idempotency: reprocessing same blob should not create duplicate records.
- Improve status transitions and error storage:
  - store lastError, retryCount, processedAt
- Add structured logs for each stage:
  - OCR started/completed
  - Cosmos upsert
  - Search push
- Confirm trigger path conventions match your blob path scheme.

9.9 Upload type restrictions (temporary workaround allowed, but backend must enforce)
- Add allowlist in upload-init:
  - For your current “only vision configured” assumption, images only is OK temporarily.
  - Later allow PDF if desired.
- Confirm how blob trigger handles non-image uploads (should fail gracefully).

9.10 Vision tagging/object detection (explicitly not for Part 3 unless asked)
- Keep as a later enhancement:
  - Use Azure Vision Image Analysis to produce tags/objects/people
  - Store tags into Cosmos evidence record and push to Search tags field
- “Gore/blood” detection likely needs custom approach; treat as optional future scope.

================================================================================
10) Artifacts produced in this chat
================================================================================
- A complete backend folder was produced (as a zip) implementing Azure Functions backend.
- You deployed it to Azure.
- You set up APIM operations manually (Option B) and verified operations list.
- You adjusted routes and backend files to fix issues and match working APIM routes.
- You updated the Azure AI Search index definition to include needed fields and enable search.

================================================================================
11) Known “current state” notes (as of your last message)
================================================================================
- “All tests are working” (your confirmation).
- APIM operations reflect updated evidence routes (/api/evidence/id/...).
- Azure AI Search index exists and supports extractedText/tags etc.
- Vision OCR is working; object detection/tagging not implemented.

================================================================================
12) What Part 4 will do (for context only; not Part 3)
================================================================================
- Part 4 is frontend adaptation: update React frontend to use:
  - Entra auth (MSAL redirect flow)
  - /api/auth/me
  - SAS upload-init → PUT Blob → upload-confirm
  - Updated evidence id routes (/api/evidence/id/{evidenceId})
  - Remove legacy/unused endpoints (analytics, etc.)

END OF PART 2 HANDOFF REPORT
"""