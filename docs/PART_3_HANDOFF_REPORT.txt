DIGITAL EVIDENCE MANAGEMENT SYSTEM
PART 3 HANDOFF REPORT
Backend + Azure Finalization State

------------------------------------------------------------
1. BACKEND STATUS (LOCKED)
------------------------------------------------------------

Architecture:
- Azure Functions (Node.js + TypeScript)
- HTTP-triggered APIs
- Blob-trigger processing pipeline
- Cosmos DB (Core SQL API)
- Azure AI Search
- Azure Storage (SAS-based uploads)
- Azure API Management (APIM) as front door
- Entra ID (JWT auth via APIM + backend validation)
- Managed Identity + Key Vault for secrets

Frontend base URL:
https://apim-dems1.azure-api.net/func-dems1


------------------------------------------------------------
2. AUTHENTICATION + AUTHORIZATION (FINAL BEHAVIOR)
------------------------------------------------------------

JWT:
- Audience validated: api://5c696d12-ced1-409f-bde9-5806053165b3
- Accepts both v1 and v2 issuers
- Roles parsed from 'roles' claim

Supported roles:
- admin
- detective
- case_officer
- prosecutor

RBAC Rules (STRICT):

ADMIN
- Governance only (departments + users)
- ZERO access to cases, evidence, search

DETECTIVE
- Full CRUD across all departments, cases, evidence

CASE_OFFICER
- CRUD only within assigned department
- Department assignment stored in Cosmos users container (id = oid)

PROSECUTOR
- Read-only across all departments, cases, evidence


------------------------------------------------------------
3. DATA MODEL RELATIONSHIPS (ENFORCED SERVER-SIDE)
------------------------------------------------------------

Department → Case → Evidence

Rules:
- Case cannot be created without valid department
- Evidence cannot be created without valid case
- Evidence.department is copied from Case.department

Cascade Deletes:
- Deleting Department deletes all Cases and Evidence under it
- Deleting Case deletes all Evidence under it


------------------------------------------------------------
4. STORAGE + PROCESSING PIPELINE
------------------------------------------------------------

Upload Flow:
1. POST /api/evidence/upload-init
2. Backend validates access + case existence
3. Returns SAS URL + blob path
4. Frontend uploads directly to Blob Storage
5. POST /api/evidence/upload-confirm
6. Blob trigger fires
7. Extracted text stored
8. Search index updated
9. Status becomes COMPLETED

No Event Grid.
No Analytics Service.


------------------------------------------------------------
5. COSMOS CONTAINERS (FINAL SHAPE)
------------------------------------------------------------

departments
- id (pk)
- name
- description

cases
- id (pk)
- department
- title
- status
- createdAt

evidence
- id (pk)
- caseId
- department
- fileName
- fileType
- status
- uploadedAt
- uploadedBy
- extractedText

users
- id (oid)
- department
- displayName
- email


------------------------------------------------------------
6. AZURE ROLE ASSIGNMENTS (MANAGED IDENTITY)
------------------------------------------------------------

Function App (func-dems1) requires:

Storage:
- Storage Blob Data Contributor

Cosmos:
- Cosmos DB Built-in Data Contributor

Search:
- Search Index Data Contributor

Key Vault:
- Key Vault Secrets User (or existing working permissions)


------------------------------------------------------------
7. FINAL API ROUTES
------------------------------------------------------------

GET    /api/auth/me
GET    /api/departments
POST   /api/departments (admin)
PATCH  /api/departments/{id} (admin)
DELETE /api/departments/{id} (admin, cascade)

GET    /api/cases
POST   /api/cases
GET    /api/cases/{caseId}
PATCH  /api/cases/{caseId}
DELETE /api/cases/{caseId}

POST   /api/evidence/upload-init
POST   /api/evidence/upload-confirm
GET    /api/evidence
GET    /api/evidence/id/{evidenceId}
DELETE /api/evidence/id/{evidenceId}
GET    /api/evidence/id/{evidenceId}/status
GET    /api/evidence/search

GET    /api/users (admin)
PATCH  /api/users/{oid} (admin)


------------------------------------------------------------
8. WHAT PART 4 (FRONTEND) MUST ADAPT TO
------------------------------------------------------------

Frontend must:

1. Use /api/auth/me to determine role-based routing.
2. Hide investigative screens if role = admin only.
3. Handle 403 properly (RBAC enforcement).
4. Call PATCH /api/users/{oid} to assign department for case_officer.
5. Respect that case_officer only sees assigned department data.
6. Expect search results to already be department-filtered.
7. Handle evidence delete endpoint if UI supports it.

No backend schema changes expected in Part 4.
No Azure wiring changes expected.


------------------------------------------------------------
9. REMAINING OPTIONAL ITEMS (don't implement unless asked by user)
------------------------------------------------------------

- Graph provisioning endpoint is optional.
- Soft-delete not implemented (hard deletes only).
- No audit trail system implemented.

------------------------------------------------------------
END OF PART 3
------------------------------------------------------------
